<!DOCTYPE HTML>
    <html>
        <head>
            <title>Dinero</title>
            <meta name="author" content="David Cho">
            <meta name="description" content="database to track of foreign currency">    
            <link href="/static/css/bootstrap3.css" rel="stylesheet" media="screen">
            <link href="/static/css/stylesheet.css"rel="stylesheet" type="text/css">
            <script src="/static/js/jquery-1.8.2.js"></script>
            <script src="/static/js/bootstrap.js"></script>
            <script src="/static/js/knockout-2.3.0.js"></script>

            <script>
                function Entry(data) {
                    this.currency = ko.observable(data.currency);
                    this.denomination = ko.observable(data.denomination);
                    this.quantity = ko.observable(data.quantity);
                }

                function ViewModel() {
                    var self = this;
                    self.entries = ko.observableArray([]);

                    self.addOne = function(value) {
                        return value + 1;
                    };

                    self.newCurrency = ko.observable('');
                    self.newDenomination = ko.observable('');
                    self.newQuantity = ko.observable('');
                    self.newEntry = ko.computed(function() {
                        return new Entry(
                            {
                                currency : self.newCurrency(),
                                denomination : self.newDenomination(),
                                quantity : self.newQuantity()
                            }
                        )
                    });

                    self.validated = ko.computed(function() {
                        var validate = true;
                        var letters = /[\d]/;
                        var numbers = /^[0-9]+$/;

                        validate = self.newCurrency() != '' && 
                                   self.newDenomination() != '' && 
                                   self.newQuantity() != '' && 
                                   !letters.test(self.newCurrency()) && 
                                   numbers.test(self.newDenomination()) && 
                                   numbers.test(self.newQuantity());
                        return validate;
                    });
                    // Operations
                    self.sortEntries = function() {
                        self.entries.sort(function(A, B) {
                            if (A.currency() == B.currency())
                                return A.denomination() < B.denomination() ? -1 : 1;
                            return A.currency() < B.currency() ? -1 : 1;
                        })
                    };
                    self.addEntry = function() {
                        self.entries.push(self.newEntry());
                        $.ajax({
                            url : "/newEntry/",
                            type : "POST",
                            dataType: "json",
                            data : {
                                client_response : ko.toJSON(self.newEntry()),
                                csrfmiddlewaretoken: '{{ csrf_token }}'
                            },
                            success : function(result) {   
                                // alert('success');
                            },
                            error : function(xhr,errmsg,err) {
                                // alert(xhr.status + ": " + xhr.responseText);
                            }
                        });

                        self.newCurrency('');
                        self.newDenomination('');
                        self.newQuantity('');
                        self.sortEntries();
                    };

                    $.getJSON("/getEntries", function(allData) {
                        var mappedEntries = $.map(allData, function(data) {
                            return new Entry(data);
                        });
                        self.entries(mappedEntries);
                    });
                }
            </script>
        </head>
        <body>
            <img src="/static/images/map.jpg" id="background">
            
            <div id="wrap">
                <div id="main" class="container">
                    <div id="result"></div>
                    <div id="search-box">
                        <form id="search-form" action="/search" method="get">
                            <input type="text" id="s" name="q" value="Search..." onfocus='if (this.value == "Search...") {this.value = ""}' onblur='if (this.value == "") {this.value = "Search...";}'/>
                            <input type="image" src="/static/images/blank.gif" id="sbutton" />
                        </form>
                    </div>

                    <div id="container-wrap">
                        <div id="container">
                            <div id="title">
                                Foreign Currency Database
                            </div>
                            <table class="zebra">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Currency</th>
                                        <th>Denomination</th>
                                        <th>Quantity</th>
                                    </tr>
                                </thead>
                            </table>
                            <table class="zebra">
                                <tbody data-bind="foreach: entries">
                                     <tr>
                                        <td><span data-bind="text: $root.addOne($index())"></span></td>
                                        <td><span data-bind="text: currency"></span></td>
                                        <td><span data-bind="text: denomination"></span></td>
                                        <td><span data-bind="text: quantity"></span></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div id="inputs">
                        <div id="group1">
                            <input type="text" data-bind="value: newCurrency, valueUpdate: 'keyup'" id="currency" class="form-control input-small" placeholder="Currency" name="country" {%if errors.country%}value="Invalid currency"{%endif%}>
                        </div>
                        <div id="group2">
                            <input type="text" data-bind="value: newDenomination, valueUpdate: 'keyup'" id="denom" class="form-control input-small" placeholder="Denomination" name="denomination" {%if errors.country%}value="Invalid currency"{%endif%}>
                        </div>
                        <div id="group3">
                            <input type="text" data-bind="value: newQuantity, valueUpdate: 'keyup'" id="quantity" class="form-control input-small" placeholder="Quantity" name="quantity" {%if errors.country%}value="Invalid currency"{%endif%}>
                        </div>
                        <button class="btn btn-info" id="add" data-bind="click: addEntry, enable: validated">+</button>
                    </div>

                    <div id="edit">
                        <a data-toggle="modal" href="#edit-modal" class="btn btn-default btn-small">edit raw file</a>
                        <div class="modal fade" id="edit-modal">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                                        <h4><span id="modal-header">Edit database file</span></h4>
                                    </div>
                                    <form method="post">{% csrf_token %}
                                        <div class="modal-body" id="modal-body">
                                            <textarea name="text" class="form-control" rows="15">{{rawtext}}</textarea>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                                            <button type="submit" class="btn btn-primary" name="save-changes">Save changes</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div style="float: left; color: red;">
                        <p>Currency: <span data-bind="text: newCurrency"></span></p>
                        <p>Denomination: <span data-bind="text: newDenomination"></span></p>
                        <p>Quantity: <span data-bind="text: newQuantity"></span></p>
                    </div>
                </div>
            </div>

            <div id="footer">
                <p>Designed and built by David Cho</p>
            </div>

            <script>ko.applyBindings(new ViewModel());</script>

<script>document.write('<script src="http://' + (location.host || 'localhost').split(':')[0] + ':35729/livereload.js?snipver=1"></' + 'script>')</script>
        </body>
    </html>